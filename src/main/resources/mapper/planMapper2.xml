<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.pickcourse.mapper.PlanMapper2">

    <select id="getTourList" resultType="tourListDTO">
        SELECT
            P.ID,
            P.PLAN_NAME,
            P.PLAN_FILE_PATH,
            P.PLAN_FILE_NAME,
            TO_CHAR(P.PLAN_START_DATE, 'YYYY-MM-DD') AS planStartDate,
            TO_CHAR(P.PLAN_END_DATE, 'YYYY-MM-DD') AS planEndDate,
            P.PLAN_PRICE,
            P.PLAN_MAX_PERSONNEL,
            COUNT(PT.ID) AS participants,
            M.ID AS MEMBER_ID,
            M.MEMBER_NICKNAME
        FROM TBL_MEMBER M
                 JOIN TBL_PLAN P ON M.ID = P.MEMBER_ID
                 LEFT JOIN TBL_PARTICIPANT PT ON PT.PLAN_ID = P.ID
        WHERE P.MEMBER_ID = #{memberId}
        GROUP BY
            P.ID,
            P.PLAN_NAME,
            P.PLAN_START_DATE,
            P.PLAN_END_DATE,
            P.PLAN_MAX_PERSONNEL,
            P.PLAN_PRICE,
            P.PLAN_FILE_PATH,
            P.PLAN_FILE_NAME,
            M.ID,
            M.MEMBER_NICKNAME
        ORDER BY P.ID
    </select>

</mapper>